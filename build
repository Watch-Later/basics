#!/bin/bash
# Copyright - 2015 - Jan Christoph Uhde <Jan@UhdeJC.com>

project_root="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
build_dir="${project_root}-build"
do_test=false

args=()
cm_flags=()
for arg in $@; do
    case $arg in
        -v|--verbose)
            export VERBOSE=1
            export V=1
        ;;
        -d|--debug)
            cm_flags+=( '-DCMAKE_BUILD_TYPE=Debug' )
        ;;
        -r|--release)
            cm_flags+=( '-DCMAKE_BUILD_TYPE=Release' )
        ;;
        -t|--testing)
            cm_flags+=( '-DCMAKE_TESTING=ON' )
            do_test=true
            touch .do_test
        ;;
        -e|--examples)
            cm_flags+=( '-DLIBOBI_EXAMPLES=ON' )
        ;;
        -c|--clean)
            rm -fr $build_dir
        ;;
        --gcc)
            cm_flags+=( '-DCMAKE_CXX_COMPILER=g++' )
        ;;
        -6|--gcc-6)
            cm_flags+=( '-DCMAKE_CXX_COMPILER=g++-6' )
            cm_flags+=( '-DCMAKE_C_COMPILER=gcc-6' )
        ;;
        --clang)
            cm_flags+=( '-DCMAKE_CXX_COMPILER=clang++-4.0' )
        ;;
        --travis)
            travis=true
        ;;
        -cd|--change-directory)
            change_dir=true
        ;;
        *)
            args+=( "$arg" )
        ;;
    esac
done

msg(){
    echo "---- $1"
}
err(){
    echo "ERROR: $1"
}

ferr(){
    echo "FATAL ERROR: $1"
    exit ${2:-1}
}



msg "create dir if not existenet"
test -d $build_dir || mkdir $build_dir || ferr "failed to create build dir"

msg "change into build dir"
cd $build_dir || ferr "failed to change into build dir"

if ! [[ $travis ]]; then
    msg "running cmake"
    cmake "${cm_flags[@]}" "${args[@]}" "$project_root" || ferr "configuring with camke failed"
    echo

    msg "running make"
    make -j $(nproc) || ferr "make failed"
    echo

    if [[ -f .do_test ]]; then
        msg "running tests"
        ctest -VV || ferr "tests failed"
        echo
    fi
else
    echo "building in travis"
    echo "running cmake"
    cmake "${cm_flags[@]}" "${args[@]}" "$project_root" \
        -DOBI_UNCAUGHT_EXCEPTIONS=ON
fi
msg "build done"

if ${change_dir:-false}; then
    echo "starting shell in build directory"
    bash
fi
