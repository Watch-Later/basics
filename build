#!/bin/bash
# Copyright - 2015 - Jan Christoph Uhde <Jan@UhdeJC.com>

project_root="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
build_dir="${project_root}-build"

args=()
cm_flags=()
for arg in $@; do
    case $arg in
        -v|--verbose)
            export VERBOSE=1
            export V=1
        ;;
        -d|--debug)
            cm_flags+=( '-DCMAKE_BUILD_TYPE=Debug' )
        ;;
        -r|--release)
            cm_flags+=( '-DCMAKE_BUILD_TYPE=Release' )
        ;;
        -t|--testing)
            cm_flags+=( '-DCMAKE_TESTING=ON' )
        ;;
        -e|--examples)
            cm_flags+=( '-DLIBOBI_EXAMPLES=ON' )
        ;;
        -c|--clean)
            rm -fr $build_dir
        ;;
        --gcc)
            cm_flags+=( '-DCMAKE_CXX_COMPILER=g++' )
        ;;
        -6|--gcc-6)
            cm_flags+=( '-DCMAKE_CXX_COMPILER=g++-6' )
            cm_flags+=( '-DCMAKE_C_COMPILER=gcc-6' )
        ;;
        --clang)
            cm_flags+=( '-DCMAKE_CXX_COMPILER=clang++-4.0' )
        ;;
        --travis)
            travis=true
        ;;
        -cd|--change-directory)
            change_dir=true
        ;;
        *)
            args+=( "$arg" )
        ;;
    esac
done

test -d $build_dir || mkdir $build_dir || { exit 1; }
cd $build_dir || { exit 1; }

if ! [[ $travis ]]; then
    cmake "${cm_flags[@]}" "${args[@]}" "$project_root" && \
    make -j $(nproc)
else
    cmake "${cm_flags[@]}" "${args[@]}" "$project_root" \
        -DOBI_UNCAUGHT_EXCEPTIONS=ON
fi

if ${change_dir:-false}; then
    bash #chage to build dir
fi
